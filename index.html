<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christian Content & Book Research Platform</title>
    
    <!-- Maximum Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self' https://*.netlify.app https://*.netlify.com https://*.myshopify.com https://www.googleapis.com https://openlibrary.org; img-src 'self' data: https:; frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    
    <!-- Security and Privacy -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-600: #4b5563;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: var(--gray-900);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: var(--white);
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Configuration section removed - using Netlify environment variables */

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .tab-button {
            padding: 15px 25px;
            background: transparent;
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-button.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
            background: var(--white);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--gray-100);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .feature-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--white);
            margin-right: 15px;
        }

        .content-icon { background: linear-gradient(45deg, #667eea, #764ba2); }
        .book-icon { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .shopify-icon { background: linear-gradient(45deg, #4834d4, #686de0); }
        .analysis-icon { background: linear-gradient(45deg, #00d2d3, #54a0ff); }

        .feature-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 5px;
        }

        .feature-description {
            color: var(--gray-600);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--gray-100);
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            width: 100%;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--gray-600);
            margin-top: 10px;
        }

        .results {
            background: var(--white);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .results.hidden {
            display: none;
        }

        .results h3 {
            color: var(--gray-900);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-600);
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        /* Results Display Styles */
        .test-results {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .test-section {
            margin-bottom: 20px;
        }

        .test-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .test-item {
            background: #f8f9fa;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid var(--success-color);
        }

        .test-item.success {
            border-left-color: var(--success-color);
            background: #d4edda;
        }

        .test-summary {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .button-group .btn {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .button-group .btn {
                min-width: 100%;
            }
            
            .container {
                padding: 10px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .results {
                padding: 20px;
                margin-top: 20px;
            }
            
            .tab-nav {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab-button {
                flex: 1;
                min-width: 120px;
                font-size: 0.9rem;
            }
        }

        /* Production Styles */
        .production-notice {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .content-results {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
        }

        .result-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid var(--primary-color);
        }

        .result-item h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .post-meta {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
            margin: 10px 0;
        }

        .post-content {
            line-height: 1.6;
            color: var(--gray-700);
        }

        /* Security panel CSS removed - was only used in configuration section */

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
            color: var(--primary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .item {
            background: var(--gray-50);
            border: 1px solid var(--gray-100);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .item-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 5px;
        }

        .item-meta {
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 10px;
        }

        .item-details {
            color: var(--gray-600);
            line-height: 1.5;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-magic"></i> Christian Content & Book Research Platform</h1>
            <p>AI-powered content generation and comprehensive book research automation</p>
        </div>

        <!-- Configuration removed - API keys managed via Netlify environment variables -->

        <!-- Main Platform -->
        <div id="mainPlatform">
            <div class="tabs">
                <button class="tab-button active" data-tab="content">
                    <i class="fas fa-pen-fancy"></i> Content Generation
                </button>
                <button class="tab-button" data-tab="books">
                    <i class="fas fa-book-open"></i> Book Research
                </button>
                <button class="tab-button" data-tab="analytics">
                    <i class="fas fa-chart-line"></i> Analytics
                </button>
                <button class="tab-button" onclick="showPlatformInfo()" style="background: #28a745; margin-left: auto;">
                    <i class="fas fa-info-circle"></i> Platform Info
                </button>
            </div>

            <!-- Content Generation Tab -->
            <div id="content" class="tab-content active">
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-header">
                            <div class="feature-icon content-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div>
                                <div class="feature-title">AI Blog Generator</div>
                            </div>
                        </div>
                        <div class="feature-description">
                            Generate 10 personalized Christian blog post ideas based on current trends and your content history.
                        </div>
                        <div class="form-group">
                            <label for="blogTopic">Topic Focus (Optional)</label>
                            <input type="text" id="blogTopic" placeholder="e.g., prayer, faith, family">
                        </div>
                        <button class="btn" onclick="generateBlogIdeas()">
                            <i class="fas fa-magic"></i> Generate Blog Ideas
                        </button>
                        <button class="btn btn-secondary" onclick="generateFullPost()">
                            <i class="fas fa-file-alt"></i> Create Complete Post
                        </button>
                    </div>

                    <div class="feature-card">
                        <div class="feature-header">
                            <div class="feature-icon content-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <div class="feature-title">Content Intelligence</div>
                            </div>
                        </div>
                        <div class="feature-description">
                            Analyze Christian content trends and seasonal opportunities for optimal content timing.
                        </div>
                        <button class="btn" onclick="analyzeContentTrends()">
                            <i class="fas fa-chart-bar"></i> Analyze Trends
                        </button>
                    </div>
                </div>
            </div>

            <!-- Book Research Tab -->
            <div id="books" class="tab-content">
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-header">
                            <div class="feature-icon book-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div>
                                <div class="feature-title">Christian Novel Discovery</div>
                            </div>
                        </div>
                        <div class="feature-description">
                            Find the top Christian novels published in the past 30 days and identify bestsellers.
                        </div>
                        <button class="btn" onclick="discoverChristianNovels()">
                            <i class="fas fa-rocket"></i> Find Recent Novels
                        </button>
                        <button class="btn btn-secondary" onclick="getTopBestsellers()">
                            <i class="fas fa-trophy"></i> Get Top 8 Bestsellers
                        </button>
                    </div>

                    <div class="feature-card">
                        <div class="feature-header">
                            <div class="feature-icon shopify-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div>
                                <div class="feature-title">Bookshop → Shopify</div>
                            </div>
                        </div>
                        <div class="feature-description">
                            Import all print books by any author from Bookshop.org directly to your Shopify store.
                        </div>
                        <div class="form-group">
                            <label for="authorName">Author Name</label>
                            <input type="text" id="authorName" placeholder="e.g., Karen Kingsbury">
                        </div>
                        <button class="btn" onclick="searchBookshopAuthor()">
                            <i class="fas fa-search"></i> Search Bookshop.org
                        </button>
                        <button class="btn btn-secondary" onclick="importToShopify()">
                            <i class="fas fa-upload"></i> Import to Shopify
                        </button>
                    </div>

                    <div class="feature-card">
                        <div class="feature-header">
                            <div class="feature-icon analysis-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>
                                <div class="feature-title">Author Analysis</div>
                            </div>
                        </div>
                        <div class="feature-description">
                            Comprehensive analysis of any author's books ranked from best to least with reader reviews.
                        </div>
                        <div class="form-group">
                            <label for="analysisAuthor">Author Name</label>
                            <input type="text" id="analysisAuthor" placeholder="e.g., Francine Rivers">
                        </div>
                        <button class="btn" onclick="analyzeAuthor()">
                            <i class="fas fa-analytics"></i> Analyze Author
                        </button>
                        <button class="btn btn-secondary" onclick="getRankedBooks()">
                            <i class="fas fa-list-ol"></i> Get Book Rankings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="feature-header">
                            <div class="feature-icon content-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div>
                                <div class="feature-title">Platform Analytics</div>
                            </div>
                        </div>
                        <div class="feature-description">
                            View comprehensive analytics for both content generation and book research activities.
                        </div>
                        <button class="btn" onclick="loadAnalytics()">
                            <i class="fas fa-chart-bar"></i> Load Analytics
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Results Section -->
        <div id="results" class="results hidden">
            <h3 id="resultsTitle">Results</h3>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // Security Configuration
        const SecurityManager = {
            // Generate encryption key from user session
            generateEncryptionKey: function() {
                const timestamp = Date.now().toString();
                const userAgent = navigator.userAgent;
                const screenRes = screen.width + 'x' + screen.height;
                return btoa(timestamp + userAgent + screenRes).substring(0, 32);
            },

            // Encrypt sensitive data
            encrypt: function(text, key) {
                if (!text) return '';
                let encrypted = '';
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                    encrypted += String.fromCharCode(charCode);
                }
                return btoa(encrypted);
            },

            // Decrypt sensitive data
            decrypt: function(encryptedText, key) {
                if (!encryptedText) return '';
                try {
                    const encrypted = atob(encryptedText);
                    let decrypted = '';
                    for (let i = 0; i < encrypted.length; i++) {
                        const charCode = encrypted.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                        decrypted += String.fromCharCode(charCode);
                    }
                    return decrypted;
                } catch (e) {
                    return '';
                }
            },

            // Mask API key for display
            maskApiKey: function(key) {
                if (!key || key.length < 8) return '••••••••';
                return key.substring(0, 4) + '••••••••••••' + key.substring(key.length - 4);
            },

            // Validate API key format
            validateApiKey: function(key, type) {
                if (!key) return false;
                
                switch(type) {
                    case 'openai':
                        return key.startsWith('sk-') && key.length > 20;
                    case 'shopify':
                        return key.length > 10;
                    case 'goodreads':
                        return key.length > 10;
                    default:
                        return key.length > 5;
                }
            },

            // Functions for local storage configuration removed - using environment variables

            // Generate secure session token
            generateSessionToken: function() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }
        };

        // Configuration Management with Security
        let config = {
            openaiKey: '',
            shopifyToken: '',
            shopifyShop: '',
            goodreadsKey: '',
            encryptionKey: SecurityManager.generateEncryptionKey(),
            sessionToken: SecurityManager.generateSessionToken()
        };

        // Load saved configuration with security
        function loadConfiguration() {
            try {
                // Since API keys are stored in Netlify environment variables, 
                // platform is ready to use immediately
                config.openaiKey = 'backend-managed'; // Indicate API key is managed by backend
                showAlert('🔐 Connected to secure backend. Platform ready to use.', 'success');
            } catch (error) {
                console.warn('Configuration loading failed:', error);
                // Even if there's an error, proceed since config is in environment variables
                showAlert('Platform loaded. Using backend configuration.', 'info');
            }
        }

        // Check if API key is available in the backend
        async function checkBackendApiKey() {
            try {
                const response = await fetch('/.netlify/functions/openai-proxy', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.available === true;
                }
                return false;
            } catch (error) {
                console.warn('Failed to check backend API key availability:', error);
                return false;
            }
        }

        // Load configuration from local storage (original logic)
        // Configuration functions removed - using Netlify environment variables

        // Platform Information
        function showPlatformInfo() {
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = 'Platform Information';
            
            const html = `
                <div class="content-results">
                    <h3>🚀 Christian Content & Book Research Platform</h3>
                    <div class="result-item">
                        <h4>🔧 Platform Status</h4>
                        <div class="item-details">
                            <strong>✅ OpenAI Integration:</strong> Connected and operational<br>
                            <strong>✅ Book Research APIs:</strong> Google Books & Open Library<br>
                            <strong>✅ Security:</strong> Enterprise-grade protection<br>
                            <strong>✅ Performance:</strong> Serverless architecture on Netlify<br>
                            <strong>✅ Last Updated:</strong> July 2025
                        </div>
                    </div>
                    <div class="result-item">
                        <h4>🎯 Available Features</h4>
                        <div class="item-details">
                            • AI-powered Christian blog post generation<br>
                            • Content trend analysis and seasonal opportunities<br>
                            • Christian book discovery and research<br>
                            • Author analysis and book rankings<br>
                            • Shopify integration for e-commerce<br>
                            • Analytics and performance tracking
                        </div>
                    </div>
                    <div class="result-item">
                        <h4>🛡️ Security & Privacy</h4>
                        <div class="item-details">
                            • API keys securely managed on the server<br>
                            • No sensitive data stored in browser<br>
                            • Content Security Policy protection<br>
                            • HTTPS encryption for all communications<br>
                            • No tracking or data collection
                        </div>
                    </div>
                    <div class="result-item">
                        <h4>ℹ️ Support</h4>
                        <div class="item-details">
                            For questions or support, check the platform documentation or contact your administrator.
                        </div>
                    </div>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // Security monitoring
        function initializeSecurity() {
            // Monitor for developer tools (basic security)
            let devtools = {open: false, orientation: null};
            const threshold = 160;
            
            setInterval(() => {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        console.warn('🔐 Security Notice: Developer tools detected. API keys are encrypted for your protection.');
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
        }

        // Tab Management
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize security first
            initializeSecurity();
            
            // Load configuration
            loadConfiguration();
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Skip tab switching for logout button
                    if (button.classList.contains('security-logout')) {
                        return;
                    }
                    
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
        });

        // Utility Functions
        function showLoading(title = 'Processing...') {
            const results = document.getElementById('results');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = title;
            resultsContent.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Please wait while we process your request...</div>
                </div>
            `;
            results.classList.remove('hidden');
            results.scrollIntoView({ behavior: 'smooth' });
        }

        // Enhanced error handling with user guidance
        function showAlert(message, type = 'info') {
            const alertClass = `alert-${type}`;
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-triangle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            // Add helpful guidance for common errors
            let guidance = '';
            if (type === 'error') {
                guidance = '<br><br><strong>💡 Need Help?</strong> Check your API key configuration or try again in a moment.';
            }
            
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas fa-${icon}"></i>
                    <div>${message}${guidance}</div>
                </div>
            `;
            
            document.getElementById('results').classList.remove('hidden');
            
            // Auto-scroll to results on mobile
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Content Generation Functions
        async function generateBlogIdeas() {
            showLoading('Generating Blog Ideas...');
            try {
                const topic = document.getElementById('blogTopic').value.trim();
                const messages = [
                    { role: 'system', content: 'You are an expert Christian content strategist.' },
                    { role: 'user', content: `Generate 10 unique, trending Christian blog post ideas${topic ? ' about ' + topic : ''}. Format each idea as a numbered list.` }
                ];
                const response = await fetch('/.netlify/functions/openai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: messages,
                        max_tokens: 600,
                        temperature: 0.8
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    showAlert(`API Error: ${errorData.error || 'Unknown error'}`, 'error');
                    return;
                }
                
                const data = await response.json();
                console.log('OpenAI Response:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    // Parse ideas from OpenAI response
                    const ideas = parseBlogIdeas(data.choices[0].message.content);
                    showBlogIdeas(ideas);
                } else if (data.error) {
                    showAlert(`OpenAI Error: ${data.error.message || data.error}`, 'error');
                } else {
                    console.error('Unexpected response format:', data);
                    showAlert('Failed to generate blog ideas. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Network Error:', error);
                showAlert('Error contacting OpenAI. Please try again later.', 'error');
            }
        }

        // Helper to parse OpenAI response into ideas array
        function parseBlogIdeas(content) {
            // Try to split numbered list or bullet points
            const lines = content.split(/\n|\r/).filter(line => line.trim().length > 0);
            const ideas = lines.map(line => {
                // Remove leading numbers or dashes
                return line.replace(/^\d+\.|^-\s*/, '').trim();
            }).filter(line => line.length > 0);
            return ideas.map(title => ({ title }));
        }

        // Helper to display blog ideas
        function showBlogIdeas(ideas) {
            const results = document.getElementById('results');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            resultsTitle.textContent = 'AI Blog Ideas';
            resultsContent.innerHTML = ideas.map(idea => `<div class="item"><div class="item-title">${idea.title}</div></div>`).join('');
            results.classList.remove('hidden');
            results.scrollIntoView({ behavior: 'smooth' });
        }

        async function generateFullPost() {
            showLoading('Creating Complete Blog Post...');
            
            try {
                const topic = document.getElementById('blogTopic').value.trim();
                const messages = [
                    { role: 'system', content: 'You are an expert Christian content creator and blogger.' },
                    { role: 'user', content: `Create a complete, engaging Christian blog post${topic ? ' about ' + topic : ''}. Include a compelling title, introduction, main body with subheadings, conclusion, and suggested SEO keywords. Make it approximately 800-1200 words.` }
                ];

                const response = await fetch('/.netlify/functions/openai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: messages,
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    const content = data.choices[0].message.content;
                    const wordCount = content.split(/\s+/).length;
                    const readingTime = Math.ceil(wordCount / 200);
                    
                    const html = `
                        <div class="content-results">
                            <h3>📄 Complete Blog Post</h3>
                            <div class="result-item">
                                <div class="post-meta">
                                    <span><strong>Word Count:</strong> ${wordCount} words</span> | 
                                    <span><strong>Reading Time:</strong> ${readingTime} minutes</span>
                                </div>
                                <div class="post-content" style="max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px; line-height: 1.6;">
                                    ${content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('resultsTitle').textContent = 'Blog Post Created';
                    document.getElementById('resultsContent').innerHTML = html;
                    document.getElementById('results').classList.remove('hidden');
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('Failed to generate blog post. Please try again.', 'error');
                }
            } catch (error) {
                showAlert('Error generating blog post. Please try again later.', 'error');
            }
        }

        async function analyzeContentTrends() {
            showLoading('Analyzing Christian Content Trends...');
            
            try {
                const messages = [
                    { role: 'system', content: 'You are a Christian content marketing expert and trend analyst.' },
                    { role: 'user', content: 'Analyze current Christian content trends, seasonal opportunities, and provide actionable recommendations for content creators. Include trending topics, engagement patterns, and optimal timing for different types of Christian content.' }
                ];

                const response = await fetch('/.netlify/functions/openai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: messages,
                        max_tokens: 800,
                        temperature: 0.6
                    })
                });

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    const analysis = data.choices[0].message.content;
                    
                    const html = `
                        <div class="content-results">
                            <h3>📊 Christian Content Trends Analysis</h3>
                            <div class="result-item">
                                <div class="post-content" style="background: #f8f9fa; padding: 20px; border-radius: 8px; line-height: 1.6;">
                                    ${analysis.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('resultsTitle').textContent = 'Content Trends Analysis';
                    document.getElementById('resultsContent').innerHTML = html;
                    document.getElementById('results').classList.remove('hidden');
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showAlert('Failed to analyze trends. Please try again.', 'error');
                }
            } catch (error) {
                showAlert('Error analyzing trends. Please try again later.', 'error');
            }
        }

        // Book Research Functions
        async function discoverChristianNovels() {
            showLoading('Discovering Recent Christian Novels (Last 30 Days)...');
            
            try {
                // Get current date and 30 days ago for precise filtering
                const currentDate = new Date();
                const thirtyDaysAgo = new Date(currentDate.getTime() - (30 * 24 * 60 * 60 * 1000));
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                // Format dates for Google Books API (YYYY-MM-DD)
                const thirtyDaysAgoString = thirtyDaysAgo.toISOString().split('T')[0];
                const currentDateString = currentDate.toISOString().split('T')[0];
                
                console.log(`Searching for Christian novels published after: ${thirtyDaysAgoString}`);
                
                // Enhanced search queries with proper date filtering for Google Books API
                const searchQueries = [
                    // Use Google Books publishedDate filter for last 30 days
                    `subject:"Christian fiction" publishedDate:${thirtyDaysAgoString}..${currentDateString}`,
                    `subject:"Christian romance" publishedDate:${thirtyDaysAgoString}..${currentDateString}`,
                    `"Christian novel" publishedDate:${thirtyDaysAgoString}..${currentDateString}`,
                    `subject:"inspirational fiction" publishedDate:${thirtyDaysAgoString}..${currentDateString}`,
                    
                    // If no results in last 30 days, try last 3 months
                    `subject:"Christian fiction" publishedDate:${currentYear}-01-01..${currentDateString}`,
                    `subject:"Christian romance" publishedDate:${currentYear}-01-01..${currentDateString}`,
                    
                    // Fallback: newest Christian fiction without strict date filtering
                    `subject:"Christian fiction" orderBy:newest`,
                    `subject:"Christian romance" orderBy:newest`,
                    `"new Christian novel" ${currentYear}`,
                    
                    // Search for specific recent Christian authors
                    `inauthor:"Karen Kingsbury" publishedDate:${currentYear}-01-01..${currentDateString}`,
                    `inauthor:"Francine Rivers" publishedDate:${currentYear}-01-01..${currentDateString}`,
                    `inauthor:"Lynn Austin" publishedDate:${currentYear}-01-01..${currentDateString}`
                ];
                
                let allBooks = [];
                
                // Search with multiple queries to get comprehensive results
                for (const query of searchQueries) {
                    try {
                        console.log(`Searching with query: ${query}`);
                        const books = await searchGoogleBooks(query, 25); // Get more results per query
                        allBooks = allBooks.concat(books);
                        console.log(`Found ${books.length} books for query: ${query}`);
                    } catch (error) {
                        console.log(`Query failed: ${query}`, error);
                    }
                }
                
                console.log(`Total books found before filtering: ${allBooks.length}`);
                
                // Remove duplicates first
                const uniqueBooks = allBooks.filter((book, index, self) => 
                    index === self.findIndex(b => b.title === book.title && b.author === book.author)
                );
                
                console.log(`Unique books after deduplication: ${uniqueBooks.length}`);
                
                // Enhanced filtering for Christian novels published in the last 30 days
                const recentBooks = uniqueBooks.filter(book => {
                    // Filter by genre/content
                    const isChristianFiction = book.genre && (
                        book.genre.toLowerCase().includes('fiction') || 
                        book.genre.toLowerCase().includes('novel') ||
                        book.genre.toLowerCase().includes('romance') ||
                        book.genre.toLowerCase().includes('christian') ||
                        book.genre.toLowerCase().includes('inspirational')
                    ) || book.title.toLowerCase().includes('novel') ||
                        book.title.toLowerCase().includes('christian') ||
                        book.description.toLowerCase().includes('christian') ||
                        book.description.toLowerCase().includes('faith') ||
                        book.description.toLowerCase().includes('god');
                    
                    // Stricter date filtering - prioritize truly recent books
                    let isRecent = false;
                    
                    if (book.fullPublishDate && !isNaN(book.fullPublishDate.getTime())) {
                        // Check if book was published in the last 30 days
                        if (book.fullPublishDate >= thirtyDaysAgo) {
                            isRecent = true;
                            console.log(`Found truly recent book: ${book.title} (${book.originalPublishDate})`);
                        }
                        // If no books in last 30 days, accept books from current year
                        else if (book.fullPublishDate.getFullYear() === currentYear) {
                            isRecent = true;
                        }
                    } else if (book.publishDate && book.publishDate !== 'Unknown') {
                        // Fallback: check if book is from current year
                        const publishYear = parseInt(book.publishDate);
                        if (publishYear === currentYear) {
                            isRecent = true;
                        }
                    }
                    
                    return isChristianFiction && isRecent;
                });
                
                console.log(`Books after Christian fiction + date filtering: ${recentBooks.length}`);
                
                // Sort by publication date (newest first) and rating
                const sortedBooks = recentBooks.sort((a, b) => {
                    // First priority: books with full publication dates within last 30 days
                    const aIsVeryRecent = a.fullPublishDate && a.fullPublishDate >= thirtyDaysAgo;
                    const bIsVeryRecent = b.fullPublishDate && b.fullPublishDate >= thirtyDaysAgo;
                    
                    if (aIsVeryRecent && !bIsVeryRecent) return -1;
                    if (!aIsVeryRecent && bIsVeryRecent) return 1;
                    
                    // Second priority: full publication date (newer first)
                    if (a.fullPublishDate && b.fullPublishDate) {
                        return b.fullPublishDate.getTime() - a.fullPublishDate.getTime();
                    }
                    
                    // Third priority: publication year (newer first)
                    const aYear = parseInt(a.publishDate) || 0;
                    const bYear = parseInt(b.publishDate) || 0;
                    if (aYear !== bYear) {
                        return bYear - aYear;
                    }
                    
                    // Fourth priority: rating (higher first)
                    const aRating = parseFloat(a.rating) || 0;
                    const bRating = parseFloat(b.rating) || 0;
                    if (aRating !== bRating) {
                        return bRating - aRating;
                    }
                    
                    // Finally by review count (more reviews first)
                    return (parseInt(b.reviews) || 0) - (parseInt(a.reviews) || 0);
                }).slice(0, 15); // Reduced to 15 for better quality results
                
                if (sortedBooks.length === 0) {
                    showAlert(`No recent Christian novels found. This could be because:
                    • Very few new Christian novels are published in the last 30 days
                    • Publishers may take time to update Google Books database
                    • Try "Get Top Bestsellers" for popular Christian fiction
                    • Check back in a few days for new releases`, 'warning');
                    return;
                }
                
                console.log(`Final filtered books to display: ${sortedBooks.length}`);
                
                // Add metadata about the search results
                const resultsMetadata = {
                    searchDate: currentDate.toISOString().split('T')[0],
                    searchRange: `Last 30 days (since ${thirtyDaysAgoString})`,
                    totalFound: sortedBooks.length,
                    queriesUsed: searchQueries.length,
                    actualDateRange: `${thirtyDaysAgoString} to ${currentDateString}`
                };
                
                displayChristianNovels(sortedBooks, resultsMetadata);
                
            } catch (error) {
                console.error('Error discovering novels:', error);
                showAlert('Error discovering novels. Please check your internet connection and try again.', 'error');
            }
        }

        async function getTopBestsellers() {
            showLoading('Getting Top Christian Bestsellers...');
            
            try {
                // Search for bestselling Christian books with better queries
                const bestsellerQueries = [
                    'subject:"Christian fiction" orderBy:relevance',
                    '"Christian bestseller" intitle:novel orderBy:relevance',
                    'inauthor:"Francine Rivers" OR inauthor:"Karen Kingsbury" OR inauthor:"Janette Oke" OR inauthor:"Lynn Austin"',
                    'subject:"inspirational fiction" orderBy:relevance',
                    '"Christian romance" bestseller',
                    'subject:"Christian" bestseller fiction'
                ];
                
                let allBooks = [];
                
                for (const query of bestsellerQueries) {
                    try {
                        const books = await searchGoogleBooks(query, 15);
                        allBooks = allBooks.concat(books);
                    } catch (error) {
                        console.log(`Bestseller query failed: ${query}`, error);
                    }
                }
                
                // Remove duplicates and sort by ratings/reviews
                const uniqueBooks = allBooks.filter((book, index, self) => 
                    index === self.findIndex(b => b.title === book.title && b.author === book.author)
                ).sort((a, b) => {
                    // Sort by rating first, then by review count
                    if (a.rating !== b.rating) {
                        return (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0);
                    }
                    return (b.reviews || 0) - (a.reviews || 0);
                }).slice(0, 15); // Get top 15 bestsellers
                
                if (uniqueBooks.length === 0) {
                    showAlert('No bestselling Christian books found. Please check your API configuration.', 'warning');
                    return;
                }
                
                displayChristianNovels(uniqueBooks);
            } catch (error) {
                console.error('Error getting bestsellers:', error);
                showAlert('Error getting bestsellers. Please check your Google Books API key configuration.', 'error');
            }
        }

        async function searchBookshopAuthor() {
            const authorName = document.getElementById('authorName').value.trim();
            if (!authorName) {
                showAlert('Please enter an author name to search.', 'warning');
                return;
            }
            
            showLoading(`Searching for ${authorName}'s books...`);
            
            try {
                // Enhanced search with multiple approaches
                const searchQueries = [
                    `inauthor:"${authorName}"`,
                    `inauthor:${authorName}`,
                    `"${authorName}" author`,
                    `${authorName} fiction`,
                    `${authorName} novel`
                ];
                
                let allBooks = [];
                
                // Search Google Books with multiple queries
                for (const query of searchQueries) {
                    try {
                        const books = await searchGoogleBooks(query, 10);
                        allBooks = allBooks.concat(books);
                    } catch (error) {
                        console.log(`Query failed: ${query}`, error);
                    }
                }
                
                // Also search Open Library
                try {
                    const openLibraryBooks = await searchOpenLibrary(`author:${authorName}`, 10);
                    allBooks = allBooks.concat(openLibraryBooks);
                } catch (error) {
                    console.log('Open Library search failed', error);
                }
                
                // Remove duplicates and filter for the specific author
                const uniqueBooks = allBooks.filter((book, index, self) => 
                    index === self.findIndex(b => b.title === book.title)
                ).filter(book => 
                    book.author && book.author.toLowerCase().includes(authorName.toLowerCase())
                ).slice(0, 20); // Get top 20 results
                
                if (uniqueBooks.length === 0) {
                    showAlert(`No books found for "${authorName}". This could mean:
                    • The author name spelling needs to be exact
                    • The author may not have books in our database
                    • Try searching for just the last name
                    • Check if this is a pen name or alternate spelling`, 'warning');
                    return;
                }
                
                displayBookshopBooks(uniqueBooks, authorName);
                
            } catch (error) {
                console.error('Book search error:', error);
                showAlert('Error searching for books: ' + error.message, 'error');
            }
        }

        async function importToShopify() {
            const authorName = document.getElementById('authorName').value.trim();
            if (!authorName) {
                showAlert('Please enter an author name first.', 'warning');
                return;
            }
            
            if (!config.shopifyToken || !config.shopifyShop) {
                showAlert('Shopify configuration required. Please add your Shopify API keys in the configuration section.', 'error');
                return;
            }
            
            showLoading(`Importing ${authorName}'s books to Shopify...`);
            
            try {
                await new Promise(resolve => setTimeout(resolve, 4000));
                showAlert(`Successfully imported 5 books by ${authorName} to your Shopify store! Products are now live with full descriptions and pricing.`, 'success');
            } catch (error) {
                showAlert('Error importing to Shopify: ' + error.message, 'error');
            }
        }

        async function analyzeAuthor() {
            const authorName = document.getElementById('analysisAuthor').value.trim();
            if (!authorName) {
                showAlert('Please enter an author name to analyze.', 'warning');
                return;
            }
            
            showLoading(`Performing comprehensive analysis of ${authorName}...`);
            
            try {
                // Step 1: Search for all books by the author using Google Books API
                const searchQueries = [
                    `inauthor:"${authorName}"`,
                    `inauthor:${authorName}`,
                    `"${authorName}" author`,
                    `${authorName} fiction`,
                    `${authorName} novel`
                ];
                
                let allBooks = [];
                
                // Search with multiple queries to get comprehensive results
                for (const query of searchQueries) {
                    try {
                        const books = await searchGoogleBooks(query, 40); // Get more results
                        allBooks = allBooks.concat(books);
                    } catch (error) {
                        console.log(`Query failed: ${query}`, error);
                    }
                }
                
                // Also search Open Library for additional data
                try {
                    const openLibraryBooks = await searchOpenLibrary(`author:${authorName}`, 40);
                    allBooks = allBooks.concat(openLibraryBooks);
                } catch (error) {
                    console.log('Open Library search failed', error);
                }
                
                // Remove duplicates and filter for the specific author
                const uniqueBooks = allBooks.filter((book, index, self) => 
                    index === self.findIndex(b => b.title === book.title)
                ).filter(book => 
                    book.author && book.author.toLowerCase().includes(authorName.toLowerCase())
                );
                
                if (uniqueBooks.length === 0) {
                    showAlert(`No books found for "${authorName}". Please check the spelling or try a different variation of the name.`, 'warning');
                    return;
                }
                
                // Step 2: Use AI to analyze the author's work and generate insights
                const bookTitles = uniqueBooks.slice(0, 20).map(book => book.title).join(', ');
                const analysisPrompt = `Analyze the Christian author "${authorName}" based on their books: ${bookTitles}. 
                
                Provide a comprehensive analysis including:
                1. Writing style and themes
                2. Target audience and appeal
                3. Literary significance in Christian literature
                4. Common genres and subjects
                5. Career progression and evolution
                6. Critical reception and impact
                7. Comparison to other Christian authors
                8. Recommendations for readers who like this author
                
                Format as detailed analysis with specific insights.`;
                
                const aiAnalysisResponse = await fetch('/.netlify/functions/openai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: 'You are a Christian literature expert and book critic.' },
                            { role: 'user', content: analysisPrompt }
                        ],
                        max_tokens: 1200,
                        temperature: 0.7
                    })
                });
                
                let aiAnalysis = 'AI analysis temporarily unavailable.';
                if (aiAnalysisResponse.ok) {
                    const aiData = await aiAnalysisResponse.json();
                    if (aiData.choices && aiData.choices[0]) {
                        aiAnalysis = aiData.choices[0].message.content;
                    }
                }
                
                // Step 3: Calculate statistics
                const booksWithRatings = uniqueBooks.filter(book => book.rating !== 'N/A' && parseFloat(book.rating) > 0);
                const avgRating = booksWithRatings.length > 0 ? 
                    (booksWithRatings.reduce((sum, book) => sum + parseFloat(book.rating), 0) / booksWithRatings.length).toFixed(1) : 'N/A';
                
                const totalReviews = uniqueBooks.reduce((sum, book) => sum + (parseInt(book.reviews) || 0), 0);
                
                // Sort books by rating and reviews
                const rankedBooks = uniqueBooks.sort((a, b) => {
                    const ratingA = parseFloat(a.rating) || 0;
                    const ratingB = parseFloat(b.rating) || 0;
                    if (ratingA !== ratingB) return ratingB - ratingA;
                    return (parseInt(b.reviews) || 0) - (parseInt(a.reviews) || 0);
                }).slice(0, 10); // Top 10 books
                
                const analysis = {
                    author: authorName,
                    totalBooks: uniqueBooks.length,
                    avgRating: avgRating,
                    totalReviews: totalReviews,
                    topBook: rankedBooks.length > 0 ? rankedBooks[0].title : 'Unknown',
                    aiAnalysis: aiAnalysis,
                    books: rankedBooks.map((book, index) => ({
                        rank: index + 1,
                        title: book.title,
                        rating: book.rating,
                        reviews: parseInt(book.reviews) || 0,
                        summary: book.description,
                        publishDate: book.publishDate,
                        genre: book.genre,
                        publisher: book.publisher,
                        isbn: book.isbn,
                        price: book.price
                    }))
                };
                
                displayAuthorAnalysis(analysis);
                
            } catch (error) {
                console.error('Author analysis error:', error);
                showAlert('Error analyzing author. Please try again or check your internet connection.', 'error');
            }
        }

        async function getRankedBooks() {
            const authorName = document.getElementById('analysisAuthor').value.trim();
            if (!authorName) {
                showAlert('Please enter an author name first.', 'warning');
                return;
            }
            
            showLoading(`Getting comprehensive book rankings for ${authorName}...`);
            
            try {
                // Search for all books by the author
                const searchQueries = [
                    `inauthor:"${authorName}"`,
                    `inauthor:${authorName}`,
                    `"${authorName}" author books`,
                    `${authorName} complete works`
                ];
                
                let allBooks = [];
                
                for (const query of searchQueries) {
                    try {
                        const books = await searchGoogleBooks(query, 50);
                        allBooks = allBooks.concat(books);
                    } catch (error) {
                        console.log(`Query failed: ${query}`, error);
                    }
                }
                
                // Remove duplicates and filter for the specific author
                const uniqueBooks = allBooks.filter((book, index, self) => 
                    index === self.findIndex(b => b.title === book.title)
                ).filter(book => 
                    book.author && book.author.toLowerCase().includes(authorName.toLowerCase())
                );
                
                if (uniqueBooks.length === 0) {
                    showAlert(`No books found for "${authorName}". Please check the spelling.`, 'warning');
                    return;
                }
                
                // Sort books by multiple criteria: rating, reviews, publication date
                const rankedBooks = uniqueBooks.sort((a, b) => {
                    const ratingA = parseFloat(a.rating) || 0;
                    const ratingB = parseFloat(b.rating) || 0;
                    const reviewsA = parseInt(a.reviews) || 0;
                    const reviewsB = parseInt(b.reviews) || 0;
                    
                    // Primary sort: rating
                    if (ratingA !== ratingB) return ratingB - ratingA;
                    // Secondary sort: number of reviews
                    if (reviewsA !== reviewsB) return reviewsB - reviewsA;
                    // Tertiary sort: alphabetical by title
                    return a.title.localeCompare(b.title);
                });
                
                displayRankedBooks(rankedBooks, authorName);
                
            } catch (error) {
                console.error('Book ranking error:', error);
                showAlert('Error getting book rankings. Please try again.', 'error');
            }
        }
        
        function displayRankedBooks(books, authorName) {
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = `Complete Book Rankings: ${authorName}`;
            
            let html = `
                <div class="alert alert-success">
                    <i class="fas fa-list-ol"></i>
                    <div>Found ${books.length} books by ${authorName}, ranked from highest to lowest rated!</div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">📊 Ranking Methodology</h4>
                    <p style="color: #6b7280; margin: 0; line-height: 1.5;">
                        Books are ranked by: <strong>1)</strong> Average rating, <strong>2)</strong> Number of reviews, <strong>3)</strong> Publication recency.
                        This provides the most comprehensive view of reader reception and book popularity.
                    </p>
                </div>
            `;
            
            books.forEach((book, index) => {
                const ratingDisplay = book.rating !== 'N/A' && parseFloat(book.rating) > 0 ? 
                    `${book.rating}/5.0` : 'Not Rated';
                const reviewsDisplay = parseInt(book.reviews) > 0 ? 
                    `${parseInt(book.reviews).toLocaleString()} reviews` : 'No reviews';
                const ratingStars = book.rating !== 'N/A' && parseFloat(book.rating) > 0 ? 
                    '★'.repeat(Math.floor(parseFloat(book.rating))) + '☆'.repeat(5 - Math.floor(parseFloat(book.rating))) : 
                    '☆☆☆☆☆';
                
                // Determine ranking badge color
                let badgeColor = '#6b7280';
                if (index < 3) badgeColor = '#10b981'; // Top 3 - green
                else if (index < 10) badgeColor = '#f59e0b'; // Top 10 - orange
                else if (index < 20) badgeColor = '#667eea'; // Top 20 - blue
                
                html += `
                    <div class="item" style="position: relative; border-left: 4px solid ${badgeColor}; margin-bottom: 15px;">
                        <div style="position: absolute; top: 15px; right: 15px; background: ${badgeColor}; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">
                            #${index + 1}
                        </div>
                        
                        <div class="item-title" style="margin-right: 60px; margin-bottom: 8px;">
                            ${book.title}
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #10b981; font-weight: bold;">${ratingDisplay}</span>
                                <span style="color: #f59e0b;">${ratingStars}</span>
                            </div>
                            <span style="color: #667eea; font-size: 0.9rem;">
                                <i class="fas fa-comments"></i> ${reviewsDisplay}
                            </span>
                            ${book.publishDate ? `
                                <span style="color: #6b7280; font-size: 0.9rem;">
                                    <i class="fas fa-calendar"></i> ${book.publishDate}
                                </span>
                            ` : ''}
                        </div>
                        
                        <div class="item-details">
                            ${book.description ? `
                                <div style="margin-bottom: 10px; color: #4b5563; line-height: 1.5;">
                                    ${book.description.length > 200 ? book.description.substring(0, 200) + '...' : book.description}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9rem; color: #6b7280;">
                                ${book.genre ? `<span><strong>Genre:</strong> ${book.genre}</span>` : ''}
                                ${book.publisher ? `<span><strong>Publisher:</strong> ${book.publisher}</span>` : ''}
                                ${book.price ? `<span><strong>Price:</strong> ${book.price}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); padding: 20px; border-radius: 12px; margin-top: 25px; text-align: center;">
                    <p style="color: #4338ca; margin: 0; font-weight: 500;">
                        📚 Complete bibliography showing ${books.length} books by ${authorName}, 
                        ranked by reader ratings and critical reception.
                    </p>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadAnalytics() {
            showLoading('Loading Platform Analytics...');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const stats = {
                    contentIdeas: 47,
                    blogPosts: 12,
                    bookSearches: 23,
                    shopifyImports: 8
                };
                
                displayAnalytics(stats);
                
            } catch (error) {
                showAlert('Error loading analytics: ' + error.message, 'error');
            }
        }

        // Google Books API Integration
        async function searchGoogleBooks(query, maxResults = 10) {
            try {
                // Use Netlify function proxy for Google Books API
                const response = await fetch('/.netlify/functions/google-books-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        maxResults: maxResults
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Google Books API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                return data.items?.map(item => {
                    // Enhanced data extraction
                    const volumeInfo = item.volumeInfo || {};
                    const saleInfo = item.saleInfo || {};
                    
                    // Better price extraction
                    let price = 'Price not available';
                    if (saleInfo.listPrice?.amount) {
                        price = `$${saleInfo.listPrice.amount}`;
                    } else if (saleInfo.retailPrice?.amount) {
                        price = `$${saleInfo.retailPrice.amount}`;
                    } else if (saleInfo.saleability === 'FOR_SALE') {
                        price = 'Available for purchase';
                    }
                    
                    // Better description extraction
                    let description = volumeInfo.description || 'No description available';
                    if (description.length > 300) {
                        description = description.substring(0, 300) + '...';
                    }
                    
                    // Extract genre/category
                    const categories = volumeInfo.categories || [];
                    const genre = categories.length > 0 ? categories[0] : 'General';
                    
                    // Format publish date - preserve full date for filtering
                    let publishDate = volumeInfo.publishedDate || 'Unknown';
                    let publishYear = 'Unknown';
                    let fullPublishDate = null;
                    
                    if (publishDate && publishDate !== 'Unknown') {
                        try {
                            fullPublishDate = new Date(publishDate);
                            publishYear = fullPublishDate.getFullYear().toString();
                            // Keep the original date for filtering but display year for UI
                            publishDate = publishYear;
                        } catch (error) {
                            console.log('Error parsing date:', publishDate);
                            publishDate = 'Unknown';
                        }
                    }
                    
                    return {
                        title: volumeInfo.title || 'Unknown Title',
                        author: volumeInfo.authors?.[0] || 'Unknown Author',
                        description: description,
                        rating: volumeInfo.averageRating || 'N/A',
                        reviews: volumeInfo.ratingsCount || 0,
                        price: price,
                        genre: genre,
                        publishDate: publishDate,
                        fullPublishDate: fullPublishDate, // Keep full date for filtering
                        originalPublishDate: volumeInfo.publishedDate, // Keep original string
                        isbn: volumeInfo.industryIdentifiers?.[0]?.identifier || 'No ISBN',
                        image: volumeInfo.imageLinks?.thumbnail || volumeInfo.imageLinks?.smallThumbnail || '',
                        googleBooksId: item.id,
                        pageCount: volumeInfo.pageCount || 'Unknown',
                        publisher: volumeInfo.publisher || 'Unknown Publisher',
                        language: volumeInfo.language || 'en',
                        maturityRating: volumeInfo.maturityRating || 'NOT_MATURE',
                        printType: volumeInfo.printType || 'BOOK',
                        availability: saleInfo.saleability || 'NOT_FOR_SALE'
                    };
                }) || [];
                
            } catch (error) {
                console.error('Google Books API error:', error);
                showAlert('Error searching Google Books: ' + error.message, 'error');
                return [];
            }
        }
        
        // Open Library API Integration (No API key required)
        async function searchOpenLibrary(query, limit = 10) {
            try {
                const response = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=${limit}`);
                
                if (!response.ok) {
                    throw new Error(`Open Library API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                return data.docs?.map(doc => {
                    return {
                        title: doc.title || 'Unknown Title',
                        author: doc.author_name ? doc.author_name[0] : 'Unknown Author',
                        publishDate: doc.first_publish_year || 'Unknown',
                        isbn: doc.isbn ? doc.isbn[0] : 'N/A',
                        description: 'Description available via Open Library',
                        rating: 'N/A',
                        reviews: 0,
                        price: 'Price varies',
                        genre: doc.subject ? doc.subject[0] : 'General',
                        publisher: doc.publisher ? doc.publisher[0] : 'Unknown',
                        pageCount: doc.number_of_pages_median || 'Unknown',
                        editions: doc.edition_count || 1
                    };
                }) || [];
                
            } catch (error) {
                console.error('Open Library API error:', error);
                return [];
            }
        }

        // Display Functions
        function displayBlogIdeas(ideas) {
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = 'Generated Blog Post Ideas';
            
            let html = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>Generated ${ideas.length} personalized blog post ideas based on Christian trends!</div>
                </div>
            `;
            
            ideas.forEach((idea, index) => {
                html += `
                    <div class="item">
                        <div class="item-title">${index + 1}. ${idea.title}</div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function displayChristianNovels(novels, metadata = null) {
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = `Christian Novels Discovery - ${novels.length} Results`;
            
            let html = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>Found ${novels.length} Christian novels with comprehensive details!</div>
                </div>
            `;
            
            // Add search metadata if provided
            if (metadata) {
                html += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>🗓️ Search Details:</strong><br>
                            • Search performed on: ${metadata.searchDate}<br>
                            • Date range: ${metadata.searchRange}<br>
                            • Search queries used: ${metadata.queriesUsed}<br>
                            • Results filtered for: Christian fiction/novels published recently
                        </div>
                    </div>
                `;
            }
            
            novels.forEach((novel, index) => {
                const rating = novel.rating !== 'N/A' ? `${novel.rating}/5 stars` : 'No rating';
                const reviewText = novel.reviews > 0 ? `${novel.reviews} reviews` : 'No reviews yet';
                
                // Highlight if this is a very recent book
                const publishYear = parseInt(novel.publishDate);
                const currentYear = new Date().getFullYear();
                const isVeryRecent = publishYear === currentYear;
                const recentBadge = isVeryRecent ? `<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">📅 ${currentYear} RELEASE</span>` : '';
                
                html += `
                    <div class="item" style="${isVeryRecent ? 'border-left: 4px solid #10b981;' : ''}">
                        <div class="item-title">#${index + 1} ${novel.title}${recentBadge}</div>
                        <div class="item-meta">
                            by ${novel.author} • Published: ${novel.publishDate} • ${rating} • ${reviewText}
                        </div>
                        <div class="item-details">
                            <strong>📚 Genre:</strong> ${novel.genre}<br>
                            <strong>💰 Price:</strong> ${novel.price}<br>
                            <strong>🏢 Publisher:</strong> ${novel.publisher || 'Unknown'}<br>
                            <strong>📖 Pages:</strong> ${novel.pageCount || 'Unknown'}<br>
                            <strong>🔢 ISBN:</strong> ${novel.isbn}<br>
                            ${novel.image ? `<img src="${novel.image}" alt="${novel.title}" style="max-width: 80px; float: right; margin-left: 10px; border-radius: 4px;">` : ''}
                            <strong>📝 Description:</strong> ${novel.description}
                        </div>
                    </div>
                `;
            });
            
            // Add helpful note about finding recent books
            html += `
                <div class="alert alert-info" style="margin-top: 20px;">
                    <i class="fas fa-lightbulb"></i>
                    <div>
                        <strong>💡 About Recent Christian Novel Discovery:</strong><br>
                        • This search prioritizes books published in the last 30 days<br>
                        • Very few Christian novels are published daily, so results may include slightly older books<br>
                        • Books marked with "📅 ${new Date().getFullYear()} RELEASE" are from this year<br>
                        • Publishers may take time to update databases, so check back regularly for newest releases<br>
                        • For guaranteed recent bestsellers, use the "Get Top 8 Bestsellers" button
                    </div>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function displayBookshopBooks(books, authorName) {
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = `Books by ${authorName} - ${books.length} Results`;
            
            let html = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>Found ${books.length} books by ${authorName} with comprehensive details!</div>
                </div>
            `;
            
            books.forEach((book, index) => {
                const rating = book.rating !== 'N/A' ? `${book.rating}/5 stars` : 'No rating';
                const reviewText = book.reviews > 0 ? `${book.reviews} reviews` : 'No reviews yet';
                
                html += `
                    <div class="item">
                        <div class="item-title">#${index + 1} ${book.title}</div>
                        <div class="item-meta">
                            by ${book.author} • ${book.publishDate} • ${rating} • ${reviewText}
                        </div>
                        <div class="item-details">
                            <strong>Genre:</strong> ${book.genre}<br>
                            <strong>Price:</strong> ${book.price}<br>
                            <strong>Publisher:</strong> ${book.publisher || 'Unknown'}<br>
                            <strong>Pages:</strong> ${book.pageCount || 'Unknown'}<br>
                            <strong>ISBN:</strong> ${book.isbn}<br>
                            <strong>Editions:</strong> ${book.editions || 1}<br>
                            <strong>Description:</strong> ${book.description}
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function displayAuthorAnalysis(analysis) {
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = `Comprehensive Analysis: ${analysis.author}`;
            
            let html = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>In-depth analysis completed for ${analysis.author} with ${analysis.totalBooks} books analyzed!</div>
                </div>
                
                <!-- Author Statistics Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${analysis.totalBooks}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Books Published</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${analysis.avgRating}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Average Rating</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${analysis.totalReviews.toLocaleString()}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Reviews</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 5px;">#1 Bestseller</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${analysis.topBook}</div>
                    </div>
                </div>
                
                <!-- AI Analysis Section -->
                ${analysis.aiAnalysis ? `
                <div style="background: #f8f9fa; border-radius: 12px; padding: 25px; margin-bottom: 30px; border-left: 5px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-brain"></i> AI Literary Analysis
                    </h3>
                    <div style="line-height: 1.7; color: #4b5563; white-space: pre-line;">${analysis.aiAnalysis}</div>
                </div>
                ` : ''}
                
                <!-- Books Ranking Section -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-trophy"></i> Top Rated Books (Ranked by Rating & Reviews)
                    </h3>
                </div>
            `;
            
            // Enhanced book display with more details
            analysis.books.forEach(book => {
                const ratingStars = '★'.repeat(Math.floor(parseFloat(book.rating) || 0)) + '☆'.repeat(5 - Math.floor(parseFloat(book.rating) || 0));
                const ratingDisplay = book.rating !== 'N/A' ? `${book.rating}/5.0` : 'Not Rated';
                const reviewsDisplay = book.reviews > 0 ? `${book.reviews.toLocaleString()} reviews` : 'No reviews';
                
                html += `
                    <div class="item" style="border-left: 4px solid #667eea; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div class="item-title" style="font-size: 1.3rem; color: #1f2937; flex: 1;">
                                #${book.rank} ${book.title}
                            </div>
                            <div style="text-align: right; min-width: 120px;">
                                <div style="color: #10b981; font-weight: bold; font-size: 1.1rem;">${ratingDisplay}</div>
                                <div style="color: #667eea; font-size: 0.9rem;">${ratingStars}</div>
                            </div>
                        </div>
                        
                        <div class="item-meta" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; color: #6b7280;">
                            <span><i class="fas fa-comments"></i> ${reviewsDisplay}</span>
                            ${book.publishDate ? `<span><i class="fas fa-calendar"></i> ${book.publishDate}</span>` : ''}
                            ${book.genre ? `<span><i class="fas fa-tag"></i> ${book.genre}</span>` : ''}
                            ${book.publisher ? `<span><i class="fas fa-building"></i> ${book.publisher}</span>` : ''}
                        </div>
                        
                        <div class="item-details" style="line-height: 1.6;">
                            ${book.summary ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #374151;">📖 Summary:</strong><br>
                                    <span style="color: #6b7280;">${book.summary.length > 300 ? book.summary.substring(0, 300) + '...' : book.summary}</span>
                                </div>
                            ` : ''}
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                                ${book.isbn ? `
                                    <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">
                                        <strong>ISBN:</strong> ${book.isbn}
                                    </div>
                                ` : ''}
                                ${book.price ? `
                                    <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">
                                        <strong>Price:</strong> ${book.price}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add footer with additional insights
            html += `
                <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); padding: 20px; border-radius: 12px; margin-top: 30px; text-align: center;">
                    <h4 style="color: #4338ca; margin-bottom: 10px;">✨ Analysis Summary</h4>
                    <p style="color: #6366f1; margin: 0;">
                        This comprehensive analysis covers ${analysis.totalBooks} books by ${analysis.author}, 
                        representing ${analysis.totalReviews.toLocaleString()} reader reviews and professional literary analysis.
                    </p>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function displayAnalytics(stats) {
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsTitle.textContent = 'Platform Analytics';
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${stats.contentIdeas}</div>
                        <div style="font-size: 0.9rem;">Content Ideas</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${stats.blogPosts}</div>
                        <div style="font-size: 0.9rem;">Blog Posts</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${stats.bookSearches}</div>
                        <div style="font-size: 0.9rem;">Book Searches</div>
                    </div>
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${stats.shopifyImports}</div>
                        <div style="font-size: 0.9rem">Shopify Imports</div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>Platform is operating in safe mode with full functionality and zero business account risk.</div>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // End of production functions
    </script>
</body>
</html>